<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GML - 2025 - Atendimentos</title>
<link rel="icon" href="https://arildomello.github.io/propriospublicos/assets/img/Ico.ico">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#07051a;color:#fff}
.hidden{display:none}
.container{max-width:1200px;margin:auto;padding:20px}
h1{text-align:center}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.card{background:#2f7bff;padding:15px;border-radius:10px;text-align:center}
.panel{background:#14123b;padding:15px;border-radius:10px;margin-top:15px}
.row{display:grid;grid-template-columns:1fr 120px 120px;padding:10px;border-bottom:1px solid #333;cursor:pointer;align-items:center}
.row.header{font-weight:bold;background:#1d1a50}
.row:hover{background:#1d1a50}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
.header{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>

<div class="container">
<h1>Atendimentos 2025</h1>
<div id="status">Carregando...</div>

<!-- SECRETARIAS -->
<section id="secSecretarias">
<h2>Secretarias</h2>
<div id="cardsSec" class="cards"></div>
<div id="listaSec" class="panel"></div>
</section>

<!-- PROPRIOS -->
<section id="secProprios" class="hidden">
<div class="header">
<h2 id="tituloProprios"></h2>
<button onclick="voltarSecretarias()">← Voltar</button>
</div>
<div id="listaProprios" class="panel"></div>
</section>

<!-- CRIMES -->
<section id="secCrimes" class="hidden">
<div class="header">
<h2 id="tituloCrimes"></h2>
<div>
<button onclick="voltarProprios()">← Voltar</button>
<button onclick="gerarPDF()">PDF</button>
</div>
</div>
<div id="listaCrimes" class="panel"></div>
</section>

</div>

<script>
/******** CONFIG ********/
const SHEET_ID='1plIRxPGmi9xRa-_47e44CXX17BevhcR4onLxu08pwnk';

const GID_AT='1768351071';
const GID_TP='764715934';

const URL_AT=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID_AT}&tqx=responseHandler:cbAt`;
const URL_TP=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID_TP}&tqx=responseHandler:cbTp`;

/******** STATE ********/
const state={secretaria:null,codPro:null,nomePro:null};

let dadosAt=[];
let dadosTp=[];

/******** DOM ********/
const statusBox=document.getElementById('status');

const secSecretarias=document.getElementById('secSecretarias');
const secProprios=document.getElementById('secProprios');
const secCrimes=document.getElementById('secCrimes');

const cardsSec=document.getElementById('cardsSec');
const listaSec=document.getElementById('listaSec');
const listaProprios=document.getElementById('listaProprios');
const listaCrimes=document.getElementById('listaCrimes');

const tituloProprios=document.getElementById('tituloProprios');
const tituloCrimes=document.getElementById('tituloCrimes');

/******** UTIL ********/
function num(v){return Number(String(v||'').replace(',','.'))||0}
function status(t){statusBox.innerText=t}

function load(url){
 return new Promise((ok,err)=>{
  const s=document.createElement('script');
  s.src=url;
  s.onload=ok;
  s.onerror=err;
  document.body.appendChild(s);
 });
}

function row(a,b,c){
 const r=document.createElement('div');
 r.className='row';
 r.innerHTML=`<div>${a}</div><div>${b}</div><div>${c}</div>`;
 return r;
}

function headerRow(){
 const r=document.createElement('div');
 r.className='row header';
 r.innerHTML='<div>Descrição</div><div>Ocorrências</div><div>Detidos</div>';
 return r;
}

function card(v,t){
 const d=document.createElement('div');
 d.className='card';
 d.innerHTML=`<h2>${v}</h2><p>${t}</p>`;
 return d;
}

/******** ATENDIMENTOS ********/

function cbAt(r){
 const rows=r?.table?.rows||[];
 if(!rows.length){status('Sem dados');return}

 dadosAt=rows.map(x=>({
  cod:x.c[0]?.v||'',
  nome:x.c[1]?.v||'',
  secretaria:x.c[3]?.v||'',
  ocorr:num(x.c[5]?.v),
  det:num(x.c[6]?.v)
 })).filter(x=>x.secretaria);

 renderSecretarias();
}

function renderSecretarias(){
 status('');
 cardsSec.innerHTML='';
 listaSec.innerHTML='';

 const grupo={};

 dadosAt.forEach(r=>{
  if(!grupo[r.secretaria]) grupo[r.secretaria]={oc:0,dt:0,loc:[]};
  grupo[r.secretaria].oc+=r.ocorr;
  grupo[r.secretaria].dt+=r.det;
  grupo[r.secretaria].loc.push(r);
 });

 const secs=Object.keys(grupo);
 let to=0,td=0;

 secs.forEach(s=>{to+=grupo[s].oc;td+=grupo[s].dt});

 cardsSec.append(
  card(secs.length,'Secretarias'),
  card(to,'Ocorrências'),
  card(td,'Detidos')
 );

 listaSec.append(headerRow());

 secs.sort((a,b)=>grupo[b].oc-grupo[a].oc);

 secs.forEach(s=>{
  const g=grupo[s];
  const r=row(s,g.oc,g.dt);
  r.onclick=()=>abrirProprios(s,g.loc);
  listaSec.append(r);
 });
}

/******** PROPRIOS ********/

function abrirProprios(sec,lista){
 state.secretaria=sec;

 secSecretarias.classList.add('hidden');
 secProprios.classList.remove('hidden');

 tituloProprios.innerText=sec;
 listaProprios.innerHTML='';
 listaProprios.append(headerRow());

 const grupo={};

 lista.forEach(r=>{
  if(!grupo[r.cod]) grupo[r.cod]={nome:r.nome,oc:0,dt:0};
  grupo[r.cod].oc+=r.ocorr;
  grupo[r.cod].dt+=r.det;
 });

 Object.entries(grupo)
 .sort(([,a],[,b])=>b.oc-a.oc)
 .forEach(([cod,g])=>{
  const r=row(`${g.nome} (${cod})`,g.oc,g.dt);
  r.onclick=()=>abrirCrimes(cod,g.nome);
  listaProprios.append(r);
 });
}

function voltarSecretarias(){
 secProprios.classList.add('hidden');
 secSecretarias.classList.remove('hidden');
}

/******** TIPOS ********/

function cbTp(r){
 const rows=r?.table?.rows||[];
 if(!rows.length) return;

 dadosTp=rows.map(x=>({
  cod:x.c[0]?.v||'',
  nome:x.c[1]?.v||'',
  tipo:x.c[2]?.v||'',
  q:num(x.c[3]?.v),
  d:num(x.c[4]?.v)
 })).filter(x=>x.cod&&x.tipo);
}

/******** CRIMES ********/

function abrirCrimes(cod,nome){
 state.codPro=cod;
 state.nomePro=nome;

 secProprios.classList.add('hidden');
 secCrimes.classList.remove('hidden');

 tituloCrimes.innerText=`${nome} (${cod})`;
 listaCrimes.innerHTML='';
 listaCrimes.append(headerRow());

 const lista=dadosTp.filter(x=>x.cod==cod);

 const grupo={};

 lista.forEach(r=>{
  if(!grupo[r.tipo]) grupo[r.tipo]={q:0,d:0};
  grupo[r.tipo].q+=r.q;
  grupo[r.tipo].d+=r.d;
 });

 Object.entries(grupo)
 .sort(([,a],[,b])=>b.q-a.q)
 .forEach(([t,g])=>{
  listaCrimes.append(row(t,g.q,g.d));
 });
}

function voltarProprios(){
 secCrimes.classList.add('hidden');
 secProprios.classList.remove('hidden');
}

/******** PDF ********/

function gerarPDF(){
 if(!state.codPro) return;

 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();

 doc.setFontSize(14);
 doc.text(`Relatório - ${state.nomePro}`,10,15);
 doc.text(`Código: ${state.codPro}`,10,22);

 const body=[];

 dadosTp
 .filter(x=>x.cod==state.codPro)
 .forEach(r=>{
  body.push([r.tipo,r.q,r.d]);
 });

 doc.autoTable({
  startY:30,
  head:[['Tipo','Ocorrências','Detidos']],
  body
 });

 doc.save(`Relatorio_${state.codPro}.pdf`);
}

/******** START ********/

async function start(){
 try{
  status('Carregando atendimentos...');
  await load(URL_AT);

  status('Carregando crimes...');
  await load(URL_TP);

  status('');
 }catch(e){
  console.error(e);
  status('Erro ao carregar dados');
 }
}

start();
</script>
</body>
</html>
