<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>GML - 2025 - Atendimentos</title>

<link rel="icon" href="https://arildomello.github.io/propriospublicos/assets/img/Ico.ico">

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

<style>

body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  background:#07051a;
  color:#fff;
}

header{
  background:#0f0b2d;
  padding:20px;
  text-align:center;
}

h1{
  margin:0;
}

main{
  max-width:1200px;
  margin:auto;
  padding:20px;
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
  margin-bottom:20px;
}

.card{
  background:#2f7bff;
  padding:15px;
  border-radius:10px;
  text-align:center;
  font-weight:bold;
}

.panel{
  background:#14123b;
  border-radius:10px;
  padding:15px;
  margin-bottom:20px;
}

.row{
  display:flex;
  justify-content:space-between;
  padding:10px;
  border-bottom:1px solid #333;
  cursor:pointer;
}

.row:hover{
  background:#1d1a50;
}

.stats{
  display:flex;
  gap:10px;
}

.pill{
  background:#07051a;
  padding:6px 10px;
  border-radius:6px;
  font-size:13px;
}

input{
  padding:8px;
  width:100%;
  margin-bottom:15px;
}

button{
  padding:8px 15px;
  background:#00e6ff;
  border:none;
  border-radius:5px;
  font-weight:bold;
  cursor:pointer;
}

button:hover{
  opacity:.8;
}

.hidden{
  display:none;
}

</style>
</head>

<body>

<header>
  <h1>Atendimentos 2025 - Próprios Públicos</h1>
</header>

<main>

<input type="search" id="busca" placeholder="Buscar secretaria ou local...">

<div id="cards" class="cards hidden"></div>

<div id="lista" class="panel hidden"></div>

<div id="detalhes" class="panel hidden"></div>

</main>

<script>

/* ================= CONFIG ================= */

const SHEET_ID = '1plIRxPGmi9xRa-_47e44CXX17BevhcR4onLxu08pwnk';

const GID_AT = '1768351071';
const GID_TP = '764715934';

const csvUrl = (id,gid)=>
  `https://docs.google.com/spreadsheets/d/${id}/export?gid=${gid}&format=csv`;

/* ================= VARIÁVEIS ================= */

let dados = [];
let agrupado = {};

/* ================= UTIL ================= */

function num(v){
  return Number(String(v).replace(',','.')) || 0;
}

function el(tag,cls){
  const e=document.createElement(tag);
  if(cls) e.className=cls;
  return e;
}

/* ================= CARREGAR ================= */

async function carregar(){

  try{

    const url = csvUrl(SHEET_ID,GID_AT);

    console.log("Carregando:",url);

    const res = await fetch(url);

    if(!res.ok) throw 'Erro HTTP';

    const txt = await res.text();

    const rows = Papa.parse(txt,{
      skipEmptyLines:true
    }).data;

    processar(rows);

  }catch(e){

    console.error(e);

    alert("Erro ao carregar planilha.");

  }

}

/* ================= PROCESSAR ================= */

function processar(rows){

  rows.shift(); // remove cabeçalho

  dados = rows.map(r=>({

    cod: r[0],
    nome: r[1],
    secretaria: r[3],
    ocorr: num(r[5]),
    det: num(r[6])

  })).filter(x=>x.secretaria);

  agrupar();

  render();

}

/* ================= AGRUPAR ================= */

function agrupar(){

  agrupado={};

  for(const r of dados){

    if(!agrupado[r.secretaria]){

      agrupado[r.secretaria]={
        total:0,
        det:0,
        locais:[]
      };

    }

    agrupado[r.secretaria].total+=r.ocorr;
    agrupado[r.secretaria].det+=r.det;

    agrupado[r.secretaria].locais.push(r);

  }

}

/* ================= RENDER ================= */

function render(){

  const cards = document.getElementById('cards');
  const lista = document.getElementById('lista');

  cards.innerHTML='';
  lista.innerHTML='';

  const secs = Object.keys(agrupado);

  let totalOc=0;
  let totalDet=0;

  secs.forEach(s=>{
    totalOc+=agrupado[s].total;
    totalDet+=agrupado[s].det;
  });

  cards.append(
    criarCard(secs.length,'Secretarias'),
    criarCard(totalOc,'Ocorrências'),
    criarCard(totalDet,'Detidos')
  );

  cards.classList.remove('hidden');
  lista.classList.remove('hidden');

  secs.sort((a,b)=>
    agrupado[b].total-agrupado[a].total
  );

  for(const s of secs){

    const g = agrupado[s];

    const row = el('div','row');

    row.innerHTML=`
      <div>${s}</div>
      <div class="stats">
        <div class="pill">Oc: ${g.total}</div>
        <div class="pill">Dt: ${g.det}</div>
      </div>
    `;

    row.onclick=()=>detalhar(s);

    lista.append(row);

  }

}

/* ================= DETALHES ================= */

function detalhar(sec){

  const box = document.getElementById('detalhes');
  box.innerHTML='';

  box.classList.remove('hidden');

  const btn = document.createElement('button');
  btn.textContent='Voltar';
  btn.onclick=()=>{
    box.classList.add('hidden');
  };

  box.append(btn);

  agrupado[sec].locais
  .sort((a,b)=>b.ocorr-a.ocorr)
  .forEach(l=>{

    const r = el('div','row');

    r.innerHTML=`
      <div>${l.nome}</div>
      <div class="stats">
        <div class="pill">Oc: ${l.ocorr}</div>
        <div class="pill">Dt: ${l.det}</div>
      </div>
    `;

    box.append(r);

  });

}

/* ================= BUSCA ================= */

document.getElementById('busca')
.addEventListener('input',e=>{

  const q = e.target.value.toLowerCase();

  const lista = document.getElementById('lista');

  lista.querySelectorAll('.row')
  .forEach(r=>{

    r.style.display =
      r.innerText.toLowerCase().includes(q)
      ? 'flex':'none';

  });

});

/* ================= START ================= */

window.onload=()=>{

  carregar();

};

</script>

</body>
</html>
